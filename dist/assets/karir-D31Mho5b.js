import"./bootstrap-icons-DZBev6aX.js";const E="http://127.0.0.1:8000/api",L=2*1024*1024,m={jobs:[],isSubmitting:!1},n={form:document.getElementById("applicationForm"),jobSelect:document.getElementById("jobId"),cvInput:document.getElementById("cv"),clInput:document.getElementById("coverLetter"),submitBtn:document.getElementById("submitBtn"),loadingOverlay:document.getElementById("loadingOverlay"),alertContainer:document.getElementById("alertContainer")};async function g(){await S(),B(),b("cv","cvUploadWrapper","cvFileInfo","cvFileName","cvFileSize"),b("coverLetter","clUploadWrapper","clFileInfo","clFileName","clFileSize")}async function S(){try{const e=await fetch(`${E}/jobs`);if(!e.ok)throw new Error("Failed to load job positions");const t=await e.json();m.jobs=t.data||t,n.jobSelect.innerHTML='<option value="" selected disabled>Pilih posisi yang tersedia...</option>',m.jobs.forEach(a=>{const i=document.createElement("option");i.value=a.id,i.textContent=a.title||a.name,n.jobSelect.appendChild(i)})}catch(e){console.error("Error loading jobs:",e),l("Gagal memuat daftar posisi. Silakan refresh halaman.","danger")}}function B(){n.form.addEventListener("submit",F),n.form.querySelectorAll("input, select").forEach(e=>{e.addEventListener("blur",()=>f(e)),e.addEventListener("input",()=>{e.classList.contains("is-invalid")&&f(e)})})}function b(e,t,a,i,s){const o=document.getElementById(e),d=document.getElementById(t),u=document.getElementById(a),v=document.getElementById(i),p=document.getElementById(s);o.addEventListener("change",r=>{const c=r.target.files[0];c&&h(c,o,u,v,p)}),d.addEventListener("dragover",r=>{r.preventDefault(),d.classList.add("drag-over")}),d.addEventListener("dragleave",()=>{d.classList.remove("drag-over")}),d.addEventListener("drop",r=>{r.preventDefault(),d.classList.remove("drag-over");const c=r.dataTransfer.files[0];c&&c.type==="application/pdf"&&(o.files=r.dataTransfer.files,h(c,o,u,v,p))})}function h(e,t,a,i,s){if(e.type!=="application/pdf"){t.value="",l("File harus berformat PDF","warning");return}if(e.size>L){t.value="",l(`Ukuran file maksimal 2MB. File Anda: ${y(e.size)}`,"warning");return}i.textContent=e.name,s.textContent=y(e.size),a.classList.add("show"),t.classList.remove("is-invalid"),t.classList.add("is-valid")}window.clearFile=function(e){const t=document.getElementById(e);t.value="",t.classList.remove("is-valid","is-invalid");const a=e==="cv"?"cv":"cl";document.getElementById(`${a}FileInfo`).classList.remove("show")};function f(e){const t=e.value.trim();let a=!0,i="";if(e.hasAttribute("required")&&!t&&(a=!1,i=`${e.previousElementSibling.textContent.replace("*","").trim()} wajib diisi`),e.type==="email"&&t&&(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)||(a=!1,i="Format email tidak valid")),e.id==="phone"&&t&&(/^[\d\s\+\-\(\)]+$/.test(t)||(a=!1,i="Format nomor telepon tidak valid")),e.type==="file"&&e.files.length>0){const o=e.files[0];o.type!=="application/pdf"?(a=!1,i="File harus berformat PDF"):o.size>L&&(a=!1,i="Ukuran file maksimal 2MB")}const s=e.parentElement.querySelector(".invalid-feedback");return a?(e.classList.remove("is-invalid"),e.classList.add("is-valid")):(e.classList.add("is-invalid"),e.classList.remove("is-valid"),s&&(s.textContent=i)),a}function w(){const e=n.form.querySelectorAll("input, select");let t=!0;return e.forEach(a=>{f(a)||(t=!1)}),t}async function F(e){if(e.preventDefault(),!w()){l("Mohon lengkapi semua field yang wajib diisi","warning");return}if(!m.isSubmitting){m.isSubmitting=!0,n.submitBtn.disabled=!0,n.submitBtn.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Mengirim...',n.loadingOverlay.classList.add("show");try{const t=new FormData(n.form),a=await fetch(`${E}/applications`,{method:"POST",body:t,headers:{Accept:"application/json"}}),i=await a.json();if(!a.ok)throw{response:a,data:i};l("Lamaran Anda berhasil dikirim! Kami akan menghubungi Anda segera.","success"),n.form.reset(),n.form.querySelectorAll(".is-valid, .is-invalid").forEach(s=>{s.classList.remove("is-valid","is-invalid")}),document.querySelectorAll(".file-info").forEach(s=>s.classList.remove("show")),setTimeout(()=>{l(`Nomor Lamaran Anda: ${i.data.application_number}`,"info")},2e3)}catch(t){console.error("Submission error:",t),t.response?.status===422&&t.data?.errors?(k(t.data.errors),l("Terdapat kesalahan pada form. Mohon periksa kembali.","danger")):l(t.data?.message||"Terjadi kesalahan. Silakan coba lagi.","danger")}finally{m.isSubmitting=!1,n.submitBtn.disabled=!1,n.submitBtn.innerHTML='<i class="bi bi-send-fill"></i> Kirim Lamaran',n.loadingOverlay.classList.remove("show")}}}function k(e){Object.keys(e).forEach(t=>{const a=n.form.querySelector(`[name="${t}"]`);if(a){a.classList.add("is-invalid"),a.classList.remove("is-valid");const i=a.parentElement.querySelector(".invalid-feedback");i&&(i.textContent=Array.isArray(e[t])?e[t][0]:e[t])}})}function l(e,t="info"){const a=document.createElement("div");a.className=`alert alert-${t} alert-dismissible fade show fade-in`,a.setAttribute("role","alert"),a.innerHTML=`
                ${e}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `,n.alertContainer.appendChild(a),setTimeout(()=>{a.remove()},5e3)}function y(e){if(e===0)return"0 Bytes";const t=1024,a=["Bytes","KB","MB"],i=Math.floor(Math.log(e)/Math.log(t));return Math.round(e/Math.pow(t,i)*100)/100+" "+a[i]}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g):g();
